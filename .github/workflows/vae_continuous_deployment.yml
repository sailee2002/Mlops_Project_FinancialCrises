name: VAE Model - Continuous Deployment

on:
  push:
    branches:
      - main
    paths:
      - "src/models/**"
      - "requirements.txt"
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  GCP_BUCKET: "mlops-financial-stress-data"
  GCP_PROJECT: "ninth-iris-422916-f2"
  KS_THRESHOLD: "0.806"
  CORR_MAE_THRESHOLD: "0.0645"

jobs:
  prepare-vae-data:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-minimal-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-minimal-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pandas numpy matplotlib seaborn scipy scikit-learn python-dotenv
      
      - name: Download VAE training data from GCS
        run: |
          echo "üì• Downloading VAE training data from GCS..."
          mkdir -p data/features
          gsutil cp gs://${{ env.GCP_BUCKET }}/data/features/macro_features_clean.csv data/features/ || echo "File not found"
          echo "‚úÖ Download complete"
      
      - name: Verify data for VAE training
        id: check_data
        run: |
          if [ -f "data/features/macro_features_clean.csv" ]; then
            echo "vae_data_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ macro_features_clean.csv found"
            python -c "import pandas as pd; df = pd.read_csv('data/features/macro_features_clean.csv'); print(f'Data shape: {df.shape}'); assert df.shape[0] > 9000 and df.shape[1] > 50, f'Expected >9000 rows and >50 columns, got {df.shape}'"
            echo "‚úÖ Data validation passed"
          else
            echo "vae_data_exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå Data not found"
          fi
      
      - name: Upload data as artifact
        if: steps.check_data.outputs.vae_data_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: vae-training-data
          path: data/features/macro_features_clean.csv
          retention-days: 7

  train-vae-models:
    runs-on: ubuntu-latest
    needs: [prepare-vae-data]
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-minimal-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-minimal-
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download training data
        uses: actions/download-artifact@v4
        with:
          name: vae-training-data
          path: data/features
      
      - name: Verify data exists
        id: check_data
        run: |
          if [ -f "data/features/macro_features_clean.csv" ]; then
            echo "data_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Training data found"
          else
            echo "data_exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå Training data not found"
          fi
      
      - name: Train Dense VAE Optimized
        if: steps.check_data.outputs.data_exists == 'true'
        run: |
          echo "üöÄ Training Dense VAE Optimized..."
          python src/models/Dense_VAE_optimized_mlflow_updated.py --no-mlflow
          echo "‚úÖ Dense VAE training complete"
        continue-on-error: false
        timeout-minutes: 60
      
      - name: Train Ensemble VAE
        if: steps.check_data.outputs.data_exists == 'true'
        run: |
          echo "üöÄ Training Ensemble VAE..."
          python src/models/Ensemble_VAE_updated.py --no-mlflow
          echo "‚úÖ Ensemble VAE training complete"
        continue-on-error: false
        timeout-minutes: 60
      
      - name: Download trained models from GCS
        if: steps.check_data.outputs.data_exists == 'true'
        run: |
          echo "üì• Downloading trained models from GCS..."
          gcloud config set project ${{ env.GCP_PROJECT }}
          
          # Create local output directories matching Python script structure
          mkdir -p outputs/output_Dense_VAE_optimized
          mkdir -p outputs/output_Ensemble_VAE
          
          # Download Dense VAE outputs
          echo "Downloading Dense VAE outputs..."
          gsutil -m cp gs://${{ env.GCP_BUCKET }}/models/vae/outputs/output_Dense_VAE_optimized/* outputs/output_Dense_VAE_optimized/ || echo "Some Dense VAE files not found"
          
          # Download Ensemble VAE outputs
          echo "Downloading Ensemble VAE outputs..."
          gsutil -m cp gs://${{ env.GCP_BUCKET }}/models/vae/outputs/output_Ensemble_VAE/* outputs/output_Ensemble_VAE/ || echo "Some Ensemble VAE files not found"
          
          echo "‚úÖ Model outputs downloaded"
      
      - name: Check training outputs
        if: steps.check_data.outputs.data_exists == 'true'
        run: |
          echo "üìä Checking training outputs..."
          
          echo "=== Dense VAE Optimized ==="
          if [ -f "outputs/output_Dense_VAE_optimized/dense_vae_scenarios.csv" ]; then
            echo "‚úÖ Dense VAE scenarios found"
            ls -lh outputs/output_Dense_VAE_optimized/dense_vae_scenarios.csv
          else
            echo "‚ö†Ô∏è Dense VAE scenarios not found"
          fi
          
          if [ -f "outputs/output_Dense_VAE_optimized/dense_vae_model.pth" ]; then
            echo "‚úÖ Dense VAE model found"
            ls -lh outputs/output_Dense_VAE_optimized/dense_vae_model.pth
          else
            echo "‚ö†Ô∏è Dense VAE model not found"
          fi
          
          echo ""
          echo "=== Ensemble VAE ==="
          if [ -f "outputs/output_Ensemble_VAE/ensemble_vae_scenarios.csv" ]; then
            echo "‚úÖ Ensemble VAE scenarios found"
            ls -lh outputs/output_Ensemble_VAE/ensemble_vae_scenarios.csv
          else
            echo "‚ö†Ô∏è Ensemble VAE scenarios not found"
          fi
          
          if [ -f "outputs/output_Ensemble_VAE/ensemble_vae_complete.pth" ]; then
            echo "‚úÖ Ensemble VAE model found"
            ls -lh outputs/output_Ensemble_VAE/ensemble_vae_complete.pth
          else
            echo "‚ö†Ô∏è Ensemble VAE model not found"
          fi
      
      - name: Upload trained models as artifact
        if: steps.check_data.outputs.data_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: vae-trained-models
          path: |
            outputs/output_Dense_VAE_optimized/*
            outputs/output_Ensemble_VAE/*
          retention-days: 30
        continue-on-error: true

  validate-vae-models:
    runs-on: ubuntu-latest
    needs: [train-vae-models]
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
      
      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-minimal-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-minimal-
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pandas numpy matplotlib seaborn scipy python-dotenv
      
      - name: Download trained models
        uses: actions/download-artifact@v4
        with:
          name: vae-trained-models
          path: .  # Download to current directory
      
      - name: Verify downloaded structure
        run: |
          echo "üìÇ Checking downloaded artifact structure..."
          ls -la
          if [ -d "outputs" ]; then
            echo "‚úÖ outputs/ directory exists"
            ls -R outputs/ | head -30
          else
            echo "‚ùå outputs/ directory not found"
            echo "Creating outputs structure..."
            mkdir -p outputs
          fi
      
      - name: Download training data
        uses: actions/download-artifact@v4
        with:
          name: vae-training-data
          path: data/features
      
      - name: Run Model Validation - Dense VAE
        id: validation_dense
        run: |
          echo "üîç Running validation for Dense VAE Optimized..."
          python src/models/model_validation.py Dense_VAE_Optimized
          echo "‚úÖ Dense VAE validation complete"
        continue-on-error: false
      
      - name: Run Model Validation - Ensemble VAE
        id: validation_ensemble
        run: |
          echo "üîç Running validation for Ensemble VAE..."
          python src/models/model_validation.py Ensemble_VAE
          echo "‚úÖ Ensemble VAE validation complete"
        continue-on-error: false
      
      - name: Check validation results
        run: |
          echo "üìä Checking validation results..."
          
          # Check Dense VAE validation
          if [ -f "outputs/validation/validation_report.txt" ]; then
            echo "‚úÖ Validation report found"
            cat outputs/validation/validation_report.txt
          else
            echo "‚ùå Validation report not found"
            exit 1
          fi
      
      - name: Upload validation results to GCS
        run: |
          echo "üì§ Uploading validation results to GCS..."
          gcloud config set project ${{ env.GCP_PROJECT }}
          
          if [ -d "outputs/validation" ]; then
            gsutil -m cp -r outputs/validation/* gs://${{ env.GCP_BUCKET }}/outputs/vae/validation/
            echo "‚úÖ Validation results uploaded"
          fi
        continue-on-error: true
      
      - name: Upload validation results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: vae-validation-results
          path: outputs/validation/*
          retention-days: 30

  bias-detection:
    runs-on: ubuntu-latest
    needs: [validate-vae-models]
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pandas numpy matplotlib seaborn scipy python-dotenv
      
      - name: Download trained models
        uses: actions/download-artifact@v4
        with:
          name: vae-trained-models
          path: outputs
      
      - name: Download training data
        uses: actions/download-artifact@v4
        with:
          name: vae-training-data
          path: data/features
      
      - name: Run Bias Detection - Dense VAE
        id: bias_dense
        run: |
          echo "üîç Running bias detection for Dense VAE Optimized..."
          python src/models/bias_detection.py Dense_VAE_Optimized
          echo "‚úÖ Dense VAE bias detection complete"
        continue-on-error: true
      
      - name: Run Bias Detection - Ensemble VAE
        id: bias_ensemble
        run: |
          echo "üîç Running bias detection for Ensemble VAE..."
          python src/models/bias_detection.py Ensemble_VAE
          echo "‚úÖ Ensemble VAE bias detection complete"
        continue-on-error: true
      
      - name: Check bias detection results
        run: |
          echo "üìä Checking bias detection results..."
          
          if [ -f "outputs/bias_detection/bias_detection_report.txt" ]; then
            echo "‚úÖ Bias detection report found"
            cat outputs/bias_detection/bias_detection_report.txt
          fi
      
      - name: Upload bias results to GCS
        run: |
          echo "üì§ Uploading bias detection results to GCS..."
          gcloud config set project ${{ env.GCP_PROJECT }}
          
          if [ -d "outputs/bias_detection" ]; then
            gsutil -m cp -r outputs/bias_detection/* gs://${{ env.GCP_BUCKET }}/outputs/vae/bias_detection/
            echo "‚úÖ Bias results uploaded"
          fi
        continue-on-error: true
      
      - name: Upload bias detection results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: vae-bias-results
          path: outputs/bias_detection/*
          retention-days: 30

  model-selection:
    runs-on: ubuntu-latest
    needs: [bias-detection]
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          df -h
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: .  # Download to current directory
      
      - name: Organize artifacts for model selection
        run: |
          echo "üìÇ Organizing artifacts..."
          
          # Move vae-trained-models contents to outputs/
          if [ -d "vae-trained-models" ]; then
            mkdir -p outputs
            cp -r vae-trained-models/* outputs/
            echo "‚úÖ Moved vae-trained-models to outputs/"
          fi
          
          # Move validation results
          if [ -d "vae-validation-results" ]; then
            cp -r vae-validation-results outputs/validation/
            echo "‚úÖ Moved validation results"
          fi
          
          # Move bias results
          if [ -d "vae-bias-results" ]; then
            cp -r vae-bias-results outputs/bias_detection/
            echo "‚úÖ Moved bias results"
          fi
          
          # Verify structure
          echo ""
          echo "Final structure:"
          ls -R outputs/ | head -20
      
      - name: Run Model Selection
        id: selection
        run: |
          echo "üèÜ Running model selection..."
          python src/models/model_selection.py
          echo "‚úÖ Model selection complete"
      
      - name: Display selected model
        run: |
          if [ -f "outputs/model_selection/model_selection.json" ]; then
            echo "üèÜ Best Model Selected:"
            cat outputs/model_selection/model_selection.json
            python -c "import json; best = json.load(open('outputs/model_selection/model_selection.json')); print(f\"\\nModel: {best['selected_model']}\\nKS Pass Rate: {best['metrics']['ks_pass_rate']:.1f}%\\nCorrelation MAE: {best['metrics']['correlation_mae']:.4f}\")"
          else
            echo "‚ùå Model selection results not found"
            exit 1
          fi
      
      - name: Upload all results to GCS
        run: |
          echo "üì§ Uploading all results to GCS..."
          gcloud config set project ${{ env.GCP_PROJECT }}
          
          # Upload model selection results
          if [ -d "outputs/model_selection" ]; then
            gsutil -m cp -r outputs/model_selection/* gs://${{ env.GCP_BUCKET }}/outputs/vae/model_selection/
          fi
          
          # Upload best model metadata
          if [ -f "outputs/model_selection/model_selection.json" ]; then
            gsutil cp outputs/model_selection/model_selection.json gs://${{ env.GCP_BUCKET }}/models/vae/best_model_selection.json
          fi
          
          echo "‚úÖ All results uploaded to GCS"
      
      - name: Upload final artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vae-final-results
          path: |
            outputs/model_selection/*
          retention-days: 90

  pipeline-summary:
    runs-on: ubuntu-latest
    needs: [prepare-vae-data, train-vae-models, validate-vae-models, bias-detection, model-selection]
    if: always()
    
    steps:
      - name: Display VAE Pipeline Summary
        run: |
          echo "================================================"
          echo "      VAE MODEL CD PIPELINE SUMMARY"
          echo "================================================"
          echo ""
          echo "üì• Data Preparation:  ${{ needs.prepare-vae-data.result }}"
          echo "üöÄ Model Training:    ${{ needs.train-vae-models.result }}"
          echo "üîç Validation:        ${{ needs.validate-vae-models.result }}"
          echo "‚öñÔ∏è  Bias Detection:    ${{ needs.bias-detection.result }}"
          echo "üèÜ Model Selection:   ${{ needs.model-selection.result }}"
          echo ""
          if [ "${{ needs.model-selection.result }}" == "success" ]; then
            echo "================================================"
            echo "‚úÖ PIPELINE COMPLETED SUCCESSFULLY!"
            echo "================================================"
            echo ""
            echo "üì¶ All artifacts stored in GCS:"
            echo "   ‚Ä¢ Training data: gs://${{ env.GCP_BUCKET }}/data/features/"
            echo "   ‚Ä¢ Models: gs://${{ env.GCP_BUCKET }}/models/vae/outputs/"
            echo "   ‚Ä¢ Validation: gs://${{ env.GCP_BUCKET }}/outputs/vae/validation/"
            echo "   ‚Ä¢ Bias detection: gs://${{ env.GCP_BUCKET }}/outputs/vae/bias_detection/"
            echo "   ‚Ä¢ Model selection: gs://${{ env.GCP_BUCKET }}/outputs/vae/model_selection/"
            echo ""
            echo "Models trained:"
            echo "  ‚Ä¢ Dense VAE Optimized (596 features, no PCA)"
            echo "  ‚Ä¢ Ensemble VAE (5 models)"
            echo ""
            echo "Next steps:"
            echo "  1. Review validation metrics in GCS"
            echo "  2. Check bias detection reports"
            echo "  3. Deploy best model to production"
          else
            echo "================================================"
            echo "‚ö†Ô∏è  PIPELINE FAILED - CHECK LOGS"
            echo "================================================"
            echo ""
            echo "Failed jobs:"
            if [ "${{ needs.prepare-vae-data.result }}" != "success" ]; then
              echo "  ‚ùå Data Preparation"
            fi
            if [ "${{ needs.train-vae-models.result }}" != "success" ]; then
              echo "  ‚ùå Model Training"
            fi
            if [ "${{ needs.validate-vae-models.result }}" != "success" ]; then
              echo "  ‚ùå Validation"
            fi
            if [ "${{ needs.bias-detection.result }}" != "success" ]; then
              echo "  ‚ùå Bias Detection"
            fi
            if [ "${{ needs.model-selection.result }}" != "success" ]; then
              echo "  ‚ùå Model Selection"
            fi
          fi